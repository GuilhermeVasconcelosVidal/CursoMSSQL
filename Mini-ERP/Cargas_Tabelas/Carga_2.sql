USE MINIERP_MULT;

--TRIGGER PARA NUMERA플O DE MATRICULAS
CREATE TRIGGER TG_NUM_MATR ON FUNCIONARIO 
  INSTEAD OF   INSERT AS
BEGIN
    DECLARE @PARAM VARCHAR(50),
	        @MATRICULA INT,
			@COD_EMPRESA INT
    --ATRIBUI PARAMETRO PESQUISA
	SET     @PARAM='MATRICULA'
	--ATRIBUI VALORES VARIAVEL
	SELECT  @MATRICULA=MATRICULA,@COD_EMPRESA=@COD_EMPRESA FROM INSERTED
	--CONDI플O
	     IF @MATRICULA =0
		   BEGIN 
		        --PEGANDO NUMERO PARA AUTO NUMERAR
				SELECT @MATRICULA=VALOR+1 FROM PARAMETROS
				WHERE PARAM=@PARAM
				AND COD_EMPRESA=@COD_EMPRESA
           --REALIZANDO INSERT
		   INSERT INTO FUNCIONARIO	
		     
			 SELECT 
			 COD_EMPRESA,@MATRICULA,COD_CC,NOME,RG,CPF,ENDERECO,NUMERO,BAIRRO,COD_CIDADE,
			 DATA_ADMISS,DATA_DEMISS,DATE_NASC,TELEFONE,COD_CARGO
			 FROM INSERTED
			 WHERE 1=1
           --REALIZANDO UPDATE	PARAMETROS
		     UPDATE PARAMETROS SET VALOR=VALOR+1
			 WHERE PARAM=@PARAM
			 AND COD_EMPRESA=@COD_EMPRESA

           END

END
--FIM TRIGGER

--CARGA TABELA FUNCIONARIO
--DELETE FROM FUNCIONARIO
--SELECT * FROM FUNCIONARIO
--SELECT * FROM PARAMETROS
--DBCC CHECKIDENT (FUNCIONARIO, RESSED, 0)
  INSERT INTO FUNCIONARIO VALUES
 (1,0,'9001','JAMES LABRIE','1234567','123567990','RUA 1','2','SANTA CLAUS','3525904','2017-01-03','','1980-12-25','','1')
INSERT INTO FUNCIONARIO VALUES
 (1,0,'9002','JONH LARAVEL','1234568','123567889','RUA 2','3','SANTA CLAUS','3525904','2017-02-10','','1980-12-25','','4')
INSERT INTO FUNCIONARIO VALUES
 (1,0,'9003','PETER DOTNESK','3434568','123564578','RUA 3','4','SANTA CLAUS','3525904','2017-02-09','','1980-12-25','','6')
INSERT INTO FUNCIONARIO VALUES
 (1,0,'9004','LARA POTTER','4434509','123576867','RUA 4','5','SANTA CLAUS','3525904','2017-03-07','','1980-12-25','','7')
 INSERT INTO FUNCIONARIO VALUES
 (1,0,'9005','JESSICA SUTER','4534576','120367887','RUA 5','6','SANTA CLAUS','3525904','2017-03-03','','1980-12-25','','5')
INSERT INTO FUNCIONARIO VALUES
 (1,0,'9006','PEDRO TESLA','4334568','123703885','RUA 6','7','SANTA CLAUS','3525904','2017-04-15','','1980-12-25','','1')
INSERT INTO FUNCIONARIO VALUES
 (1,0,'9007','TIAGO FIELDER','9834568','147034889','RUA 7','8','SANTA CLAUS','3525904','2017-04-20','','1980-12-25','','2')
INSERT INTO FUNCIONARIO VALUES
 (1,0,'9007','MALCON DEXTER','9834568','147067889','RUA 17','28','SANTA CLAUS','3525904','2017-04-20','','1980-12-25','','3')
 INSERT INTO FUNCIONARIO VALUES
 (1,0,'9007','CHARLES NOIX','9894668','147067149','RUA 77','18','SANTA CLAUS','3525904','2017-04-20','','1980-12-25','','3')
 INSERT INTO FUNCIONARIO VALUES
 (1,0,'9008','JOAO SPARK','7734568','643567888','RUA 8','22','SANTA CLAUS','3525904','2017-05-07','','1980-12-25','','9')
INSERT INTO FUNCIONARIO VALUES
 (1,0,'9009','DAVID MANDRAKE','6634568','345567887','RUA 8','56','SANTA CLAUS','3525904','2017-05-07','','1980-12-25','','8')
INSERT INTO FUNCIONARIO VALUES
 (1,0,'9002','SAMUEL DUPRET','8984568','159567887','RUA 23','89','SANTA CLAUS','3525904','2017-05-07','','1980-12-25','','10')

--SELECT * FROM FUNCIONARIO

--CARGA TABELA	USUARIOS 
--DELETE FROM USUARIOS
--SELECT * FROM USUARIOS
--SELECT NOME,MATRICULA FROM FUNCIONARIO

INSERT INTO  USUARIO (COD_EMPRESA, LOGIN,MATRICULA,SENHA,SITUACAO) VALUES
(1,'JAMESL','1','','A'),(1,'JONHL','2','','A'),
(1,'PETERD','3','','A'),(1,'LARAP','4','','A'),
(1,'JESSICAS','5','','A'),(1,'PEDROT','6','','A'),
(1,'THIAGOF','7','','A'),(1,'MALCOND','8','','A'),
(1,'CHARLESN','9','','A'),(1,'JOAOS','10','','A'),
(1,'DAVIDM','11','','A'),(1,'SAMUELD','12','','A') 

--SELECT * FROM USUARIO

--GRAVANDO E CRIPTOGRAFANDO SENHA COM MD5  COM SENHA INICIAL = MATRICULA
  UPDATE USUARIO 
  SET SENHA=CONVERT(VARCHAR(32), HASHBYTES('MD5', CONVERT(VARCHAR,MATRICULA)), 2)
	
--SELECT MATRICULA, SENHA=CONVERT(VARCHAR(32), HASHBYTES('MD5', CONVERT(VARCHAR,MATRICULA)), 2)
--FROM USUARIO
--SELECT * FROM USIARIO


--CARGA TABELA CONDI플O DE PAGAMENTO
  INSERT INTO COND_PAGTO VALUES
    ('A VISTA'),('3 X 30/60/90 DD'),('30 DD')

--CARGA DETALHE DE PAGAMENTO PARCELAS
  INSERT INTO COND_PAGTO_DET VALUES
    ('1','1',0,100)

  INSERT INTO COND_PAGTO_DET VALUES	
    ('2','1',30,33.34),
	('2','2',60,33.33),
	('2','3',90,33.33)

  INSERT INTO COND_PAGTO_DET VALUES 
    ('3','1',30,100)

--CARGA VENDEDORES

--SELECT * FROM VENDEDORES 
  INSERT INTO VENDEDORES 
  SELECT A.COD_EMPRESA,A.MATRICULA
  FROM FUNCIONARIO A
  INNER JOIN CARGOS B
  ON A.COD_EMPRESA=B.COD_EMPRESA
  AND A.COD_CARGO=B.COD_CARGO
  WHERE B.NOME_CARGO='VENDEDOR'
  AND CONCAT(A.COD_EMPRESA,A.MATRICULA) NOT IN (SELECT CONCAT(COD_EMPRESA,MATRICULA) FROM VENDEDORES)

--CARGA TABELA GERENTES

  INSERT INTO GERENTES 
  SELECT A.COD_EMPRESA,A.MATRICULA
  FROM FUNCIONARIO A
  INNER JOIN CARGOS B
  ON A.COD_EMPRESA=B.COD_EMPRESA
  AND A.COD_CARGO=B.COD_CARGO
  WHERE B.NOME_CARGO='GER COMERCIAL'
  AND CONCAT(A.COD_EMPRESA,A.MATRICULA) NOT IN (SELECT CONCAT(COD_EMPRESA,MATRICULA) FROM GERENTES)

--CARGA CANAL VENDAS GERENTE X VENDEDOR
--SELECT * FROM CANAL_VENDAS_G_V
--SELECT * FROM VENDEDORES 
--SELECT * FROM GERENTES
  INSERT INTO CANAL_VENDAS_G_V VALUES 
    (1,7,7),(1,7,8)


--CARGA CANAL VENDAS VENDEDOR X CLIENTE
--SELECT * FROM CLIENTES
--SELECT * FROM CANAL_VENDAS_V_C
  INSERT CANAL_VENDAS_V_C VALUES
    (1,7,1),(1,8,2)

--CARGA DE META DE VENDAS 
--SELECT * FROM META_VENDAS
 --use MINIERP
  INSERT INTO META_VENDAS VALUES 
  (1,7,'2018','01',83.33),(1,7,'2018','02',83.33),(1,7,'2018','03',83.33),(1,7,'2018','04',83.33),
  (1,7,'2018','05',83.33),(1,7,'2018','06',83.33),(1,7,'2018','07',83.33),(1,7,'2018','08',83.33),
  (1,7,'2018','09',83.33),(1,7,'2018','10',83.33),(1,7,'2018','11',83.33),(1,7,'2018','12',83.33)

  INSERT INTO META_VENDAS VALUES
  (1,8,'2018','01',83.33),(1,8,'2018','02',83.33),(1,8,'2018','03',83.33),(1,8,'2018','04',83.33),
  (1,8,'2018','05',83.33),(1,8,'2018','06',83.33),(1,8,'2018','07',83.33),(1,8,'2018','08',83.33),
  (1,8,'2018','09',83.33),(1,8,'2018','10',83.33),(1,8,'2018','11',83.33),(1,8,'2018','12',83.33)

--CARGA CFOP CODIGO DE OPERA합ES FISCAIS
--DELETE FROM CFOP 
  INSERT INTO CFOP VALUES
    ('5.101','VENDAS DE MERC'),('1.101','COMPRAS DE MERC')


--TRIGGER PARA NUMERA플O DE PEDIDO DE VENDA 
  CREATE TRIGGER TG_NUM_PED_V ON PED_VENDAS
    INSTEAD OF   INSERT AS
  BEGIN

    DECLARE @PARAM       VARCHAR(50),
	        @NUM_PEDIDO  INT,
			@COD_EMPRESA INT

	SET     @PARAM = 'PED_VENDAS'
	
	SELECT @NUM_PEDIDO= NUM_PEDIDO, @COD_EMPRESA=COD_EMPRESA FROM INSERTED

      IF @NUM_PEDIDO IS NULL
	    BEGIN 
		       SELECT @NUM_PEDIDO= VALOR+1  FROM PARAMETROS
			   WHERE PARAM=@PARAM
			   AND COD_EMPRESA=@COD_EMPRESA
			--REALIZANDO INSERT 
			  INSERT INTO PED_VENDAS
			    SELECT
				 COD_EMPRESA,@NUM_PEDIDO,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO,0
				  FROM INSERTED
				  WHERE 1=1
			--REALIZANDO UPDATE PARAMETROS
			    UPDATE PARAMETROS SET  VALOR = VALOR+1
				WHERE PARAM=@PARAM
				AND COD_EMPRESA=@COD_EMPRESA
        END
  END

--INSERT PED_VENDAS CABECALHO
--SELECT * FROM PED_VENDAS
--DELETE FROM PED_VENDAS
--SELECT * FROM PARAMETROS
--DBCC CHECKIDENT ( PED_VENDAS, RESSED, 0)

INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,1,1,'2018-01-13','2018-01-29','A')
INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,2,3,'2018-02-13','2018-02-28','A')
INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,1,2,'2018-03-13','2018-03-29','A')
INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,2,2,'2018-04-13','2018-04-29','A')
INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,2,3,'2018-05-13','2018-05-29','A')
INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,1,3,'2018-06-13','2018-06-29','A')
INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,2,1,'2018-07-13','2018-07-29','A')
INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,1,3,'2018-08-13','2018-08-29','A')
INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,2,2,'2018-09-13','2018-09-29','A')
INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,2,1,'2018-10-13','2018-10-29','A')
INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,1,2,'2018-11-13','2018-11-29','A')
INSERT INTO PED_VENDAS (COD_EMPRESA,ID_CLIENTE,COD_PAGTO,DATA_PEDIDO,DATA_ENTREGA,SITUACAO) VALUES
(1,2,2,'2018-12-13','2018-12-29','A')

--CARGA DETALHES DE PEDIDOS
--SELECT * FROM PED_VENDAS
--SELECT * FROM PED_VENDAS_ITENS

INSERT INTO PED_VENDAS_ITENS VALUES
  (1,1,1,1,35,2500),(1,1,2,2,40,2500),
  (1,2,1,1,50,2500),(1,2,2,2,35,2500),
  (1,3,1,1,50,2500),(1,3,2,2,35,2500),
  (1,4,1,1,50,2500),(1,4,2,2,35,2500),
  (1,5,1,1,50,2500),(1,5,2,2,35,2500),
  (1,6,1,1,50,2500),(1,6,2,2,35,2500),
  (1,7,1,1,50,2500),(1,7,2,2,35,2500),
  (1,8,1,1,70,2500),(1,8,2,2,70,2500),
  (1,9,1,1,50,2500),(1,9,2,2,35,2500),
  (1,10,1,1,50,2500),(1,10,2,2,35,2500),
  (1,11,1,1,100,2500),(1,11,2,2,100,2500),
  (1,12,1,1,50,2500),(1,12,2,2,35,2500)
--SELECT * FROM PED_VENDAS_ITENS
  

  --ATUALIZANDO TOTAL PEDIDO VENDAS COM BASE NA TAB VENDAS ITENS
  -- SELECT * FROM PED_VENDAS
	WITH PED_ITENS(COD_EMPRESA,NUM_PEDIDO,TOTAL) AS
	(
	   SELECT A.COD_EMPRESA, A.NUM_PEDIDO,SUM(A.QTD*A.VAL_UNIT) TOTAL
	   FROM PED_VENDAS_ITENS A
	   GROUP BY A.COD_EMPRESA,A.NUM_PEDIDO
	 )
      UPDATE PED_VENDAS SET	TOTAL_PED=B.TOTAL
	  FROM PED_VENDAS A
	  INNER JOIN PED_ITENS B
	  ON A.NUM_PEDIDO=B.NUM_PEDIDO
	  AND A.COD_EMPRESA=B.COD_EMPRESA

--CARGA FUNCIONARIO SALARIOS
--SELECT * FROM SALARIO

  INSERT INTO SALARIO VALUES (1,0,7650),(1,1,2650),(1,2,2550),(1,3,1550),
                             (1,4,4550),(1,5,2850),(1,6,1850),(1,7,1560),
							 (1,8,3899),(1,9,2345),(1,10,3100),(1,11,4500)

--CARGA PARAMETROS INSS VALUES 
 INSERT INTO PARAM_INSS VALUES 
  ('2018-01-01','2018-12-31',0,1659.38,8),
  ('2018-01-01','2018-12-31',1659.39,2765.66,9),
  ('2018-01-01','2018-12-31',2765.67,5531.31,11),
  ('2018-01-01','2018-12-31',5531.32,999999,0)


--CARGA PARAMETROS IRRF

--DELETE FROM PARAM_IRRF

  INSERT INTO PARAM_IRRF VALUES 
  ('2018-01-01','2018-12-31',0,1903.98,0,0),
  ('2018-01-01','2018-12-31',1903.99,2826.65,7.5,142.80),
  ('2018-01-01','2018-12-31',2826.66,3751.05,15,354.80),
  ('2018-01-01','2018-12-31',3751.06,4664.68,22.5,636.13),
  ('2018-01-01','2018-12-31',4664.68,999999,27.5,869.36)